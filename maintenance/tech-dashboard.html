<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#7c3aed">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="auth.css">
</head>
<body class="dashboard">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="dashboard-header-content">
            <h1 class="dashboard-title">Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ</h1>
            <div class="dashboard-user">
                <div class="user-avatar" id="userAvatar">Ù</div>
                <div class="user-info">
                    <div class="user-name" id="userName">ÙÙ†ÙŠ</div>
                    <div class="user-role">ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-small">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <main class="dashboard-content">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    <div class="stat-card-icon">ğŸ“Š</div>
                </div>
                <div class="stat-card-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    <div class="stat-card-icon">â±ï¸</div>
                </div>
                <div class="stat-card-value" id="pendingRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ù…ÙƒØªÙ…Ù„Ø©</div>
                    <div class="stat-card-icon">âœ…</div>
                </div>
                <div class="stat-card-value" id="completedRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">ØªÙ‚ÙŠÙŠÙ…ÙŠ</div>
                    <div class="stat-card-icon">â­</div>
                </div>
                <div class="stat-card-value" id="userRating">-</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="requests-section">
            <div class="section-header">
                <h2 class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="filterRequests('all')" class="btn btn-secondary btn-small filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
                    <button onclick="filterRequests('pending')" class="btn btn-secondary btn-small filter-btn" data-filter="pending">Ù…Ø¹Ù„Ù‚Ø©</button>
                    <button onclick="filterRequests('in-progress')" class="btn btn-secondary btn-small filter-btn" data-filter="in-progress">Ø¬Ø§Ø±ÙŠØ©</button>
                    <button onclick="filterRequests('completed')" class="btn btn-secondary btn-small filter-btn" data-filter="completed">Ù…ÙƒØªÙ…Ù„Ø©</button>
                </div>
            </div>
            <div class="requests-list" id="requestsList">
                <!-- Requests will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Update Status Modal -->
    <div class="modal" id="updateStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
                <button class="modal-close" onclick="closeUpdateModal()">Ã—</button>
            </div>
            <form class="auth-form" id="updateStatusForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newStatus" class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© *</label>
                        <select id="newStatus" class="form-input" required>
                            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                            <option value="in-progress">ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
                            <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                            <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="techNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª *</label>
                        <textarea id="techNotes" class="form-input" rows="4" required placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø­ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeUpdateModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.userType !== 'technician') {
            alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            window.location.href = 'login.html';
        }

        // Display user info
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
        document.getElementById('userRating').textContent = (currentUser.rating || 0).toFixed(1);

        let currentFilter = 'all';
        let currentRequestId = null;

        // Load requests
        function loadRequests() {
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            
            // Filter based on current filter
            let filteredRequests = requests;
            if (currentFilter !== 'all') {
                filteredRequests = requests.filter(r => r.status === currentFilter);
            }
            
            // Update stats
            document.getElementById('totalRequests').textContent = requests.length;
            document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'pending' || r.status === 'in-progress').length;
            document.getElementById('completedRequests').textContent = requests.filter(r => r.status === 'completed' && r.technicianId === currentUser.id).length;

            // Display requests
            const requestsList = document.getElementById('requestsList');
            if (filteredRequests.length === 0) {
                requestsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <h3 class="empty-state-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h3>
                        <p class="empty-state-desc">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                `;
            } else {
                requestsList.innerHTML = filteredRequests.map(request => {
                    const statusText = {
                        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                        'in-progress': 'ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                        'completed': 'Ù…ÙƒØªÙ…Ù„',
                        'rejected': 'Ù…Ø±ÙÙˆØ¶'
                    };
                    
                    const statusClass = {
                        'pending': 'status-pending',
                        'in-progress': 'status-in-progress',
                        'completed': 'status-completed',
                        'rejected': 'status-rejected'
                    };

                    const issueTypes = {
                        'electrical': 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                        'plumbing': 'Ø³Ø¨Ø§ÙƒØ©',
                        'carpentry': 'Ù†Ø¬Ø§Ø±Ø©',
                        'it': 'ØªÙ‚Ù†ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                        'ac': 'ØªÙƒÙŠÙŠÙ',
                        'other': 'Ø£Ø®Ø±Ù‰'
                    };

                    const priorityText = {
                        'low': 'ğŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø©',
                        'medium': 'ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©',
                        'high': 'ğŸ”´ Ø¹Ø§Ù„ÙŠØ©'
                    };
                    
                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <div class="request-info">
                                    <h3>${issueTypes[request.issueType] || request.issueType} - ${request.location}</h3>
                                    <div class="request-meta">
                                        <span>ğŸ‘¤ ${request.clientName}</span>
                                        <span>ğŸ“… ${new Date(request.createdAt).toLocaleDateString('ar-SA')}</span>
                                        <span>${priorityText[request.priority]}</span>
                                    </div>
                                </div>
                                <span class="request-status ${statusClass[request.status]}">${statusText[request.status]}</span>
                            </div>
                            <p class="request-description">${request.description}</p>
                            ${request.image ? `
                                <div style="margin-bottom: 1rem;">
                                    <img src="${request.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©" style="max-width: 300px; border-radius: var(--radius-lg); border: 2px solid var(--gray-200);">
                                </div>
                            ` : ''}
                            ${request.technicianNotes ? `
                                <div style="background: var(--purple-50); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem; border-right: 3px solid var(--purple-500);">
                                    <strong style="color: var(--purple-700); display: block; margin-bottom: 0.5rem;">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ:</strong>
                                    <p style="color: var(--gray-700); margin: 0;">${request.technicianNotes}</p>
                                </div>
                            ` : ''}
                            ${request.rating ? `
                                <div style="background: var(--success-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                                    <strong style="color: var(--success-dark); display: block; margin-bottom: 0.5rem;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${'â­'.repeat(request.rating)}</strong>
                                    ${request.ratingComment ? `<p style="color: var(--gray-700); margin: 0;">${request.ratingComment}</p>` : ''}
                                </div>
                            ` : ''}
                            <div class="request-actions">
                                <button onclick="openUpdateModal('${request.id}')" class="btn btn-primary btn-small">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                                ${!request.technicianId ? `<button onclick="assignToSelf('${request.id}')" class="btn btn-secondary btn-small">ØªØ¹ÙŠÙŠÙ† Ù„Ù†ÙØ³ÙŠ</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Filter requests
        function filterRequests(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');
            
            loadRequests();
        }

        // Assign request to self
        function assignToSelf(requestId) {
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            const requestIndex = requests.findIndex(r => r.id === requestId);
            
            if (requestIndex !== -1) {
                requests[requestIndex].technicianId = currentUser.id;
                requests[requestIndex].technicianName = currentUser.name;
                requests[requestIndex].status = 'in-progress';
                requests[requestIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
                
                alert('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                loadRequests();
            }
        }

        // Open/Close Update Modal
        function openUpdateModal(requestId) {
            currentRequestId = requestId;
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            const request = requests.find(r => r.id === requestId);
            
            if (request) {
                document.getElementById('newStatus').value = request.status;
                document.getElementById('techNotes').value = request.technicianNotes || '';
            }
            
            document.getElementById('updateStatusModal').classList.add('active');
        }

        function closeUpdateModal() {
            document.getElementById('updateStatusModal').classList.remove('active');
            currentRequestId = null;
        }

        // Handle status update
        document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            const requestIndex = requests.findIndex(r => r.id === currentRequestId);
            
            if (requestIndex !== -1) {
                requests[requestIndex].status = document.getElementById('newStatus').value;
                requests[requestIndex].technicianNotes = document.getElementById('techNotes').value;
                requests[requestIndex].technicianId = currentUser.id;
                requests[requestIndex].technicianName = currentUser.name;
                requests[requestIndex].updatedAt = new Date().toISOString();
                
                localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
                
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                closeUpdateModal();
                loadRequests();
            }
        });

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Add active class style for filter buttons
        const style = document.createElement('style');
        style.textContent = `
            .filter-btn.active {
                background: linear-gradient(135deg, var(--purple-600) 0%, var(--purple-800) 100%);
                color: white;
            }
        `;
        document.head.appendChild(style);

        // Load requests on page load
        loadRequests();
    </script>
</body>
</html>
