<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#7c3aed">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="auth.css">
</head>
<body class="dashboard">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="dashboard-header-content">
            <h1 class="dashboard-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h1>
            <div class="dashboard-user">
                <div class="user-avatar" id="userAvatar">Ø¹</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Ø¹Ù…ÙŠÙ„</div>
                    <div class="user-role">Ø¹Ù…ÙŠÙ„</div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-small">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <main class="dashboard-content">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    <div class="stat-card-icon">ğŸ“Š</div>
                </div>
                <div class="stat-card-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    <div class="stat-card-icon">â±ï¸</div>
                </div>
                <div class="stat-card-value" id="pendingRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-title">Ù…ÙƒØªÙ…Ù„Ø©</div>
                    <div class="stat-card-icon">âœ…</div>
                </div>
                <div class="stat-card-value" id="completedRequests">0</div>
            </div>
        </div>

        <!-- Requests Section -->
        <div class="requests-section">
            <div class="section-header">
                <h2 class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
                <button onclick="openNewRequestModal()" class="btn btn-primary">Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div class="requests-list" id="requestsList">
                <!-- Requests will be loaded here -->
            </div>
        </div>
    </main>

    <!-- New Request Modal -->
    <div class="modal" id="newRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</h2>
                <button class="modal-close" onclick="closeNewRequestModal()">Ã—</button>
            </div>
            <form class="auth-form" id="newRequestForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="issueType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ *</label>
                        <select id="issueType" class="form-input" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</option>
                            <option value="electrical">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                            <option value="plumbing">Ø³Ø¨Ø§ÙƒØ©</option>
                            <option value="carpentry">Ù†Ø¬Ø§Ø±Ø©</option>
                            <option value="it">ØªÙ‚Ù†ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                            <option value="ac">ØªÙƒÙŠÙŠÙ</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="location" class="form-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© *</label>
                        <input type="text" id="location" class="form-input" required placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØµÙ„ 201ØŒ Ø§Ù„Ù…Ø®ØªØ¨Ø±ØŒ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© *</label>
                        <textarea id="description" class="form-input" rows="4" required placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="image" class="form-label">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="file" id="image" class="form-input" accept="image/*">
                        <small class="form-hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© ØªÙˆØ¶Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</small>
                    </div>

                    <div class="form-group">
                        <label for="priority" class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                        <select id="priority" class="form-input">
                            <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                            <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                            <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeNewRequestModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h2>
                <button class="modal-close" onclick="closeRatingModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 1.5rem; color: var(--gray-600);">Ù…Ø§ Ù…Ø¯Ù‰ Ø±Ø¶Ø§Ùƒ Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©ØŸ</p>
                <div style="display: flex; justify-content: center; gap: 1rem; font-size: 2.5rem; margin-bottom: 1.5rem;">
                    <span class="rating-star" data-rating="1" onclick="selectRating(1)">â­</span>
                    <span class="rating-star" data-rating="2" onclick="selectRating(2)">â­</span>
                    <span class="rating-star" data-rating="3" onclick="selectRating(3)">â­</span>
                    <span class="rating-star" data-rating="4" onclick="selectRating(4)">â­</span>
                    <span class="rating-star" data-rating="5" onclick="selectRating(5)">â­</span>
                </div>
                <div class="form-group">
                    <label for="ratingComment" class="form-label">ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="ratingComment" class="form-input" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeRatingModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="submitRating()" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            </div>
        </div>
    </div>

    <script src="dashboard.js"></script>
    <script>
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.userType !== 'client') {
            alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            window.location.href = 'login.html';
        }

        // Display user info
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);

        // Load requests
        function loadRequests() {
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            const userRequests = requests.filter(r => r.clientId === currentUser.id);
            
            // Update stats
            document.getElementById('totalRequests').textContent = userRequests.length;
            document.getElementById('pendingRequests').textContent = userRequests.filter(r => r.status === 'pending' || r.status === 'in-progress').length;
            document.getElementById('completedRequests').textContent = userRequests.filter(r => r.status === 'completed').length;

            // Display requests
            const requestsList = document.getElementById('requestsList');
            if (userRequests.length === 0) {
                requestsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <h3 class="empty-state-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</h3>
                        <p class="empty-state-desc">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©</p>
                        <button onclick="openNewRequestModal()" class="btn btn-primary">Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                `;
            } else {
                requestsList.innerHTML = userRequests.map(request => {
                    const statusText = {
                        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                        'in-progress': 'ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                        'completed': 'Ù…ÙƒØªÙ…Ù„',
                        'rejected': 'Ù…Ø±ÙÙˆØ¶'
                    };
                    
                    const statusClass = {
                        'pending': 'status-pending',
                        'in-progress': 'status-in-progress',
                        'completed': 'status-completed',
                        'rejected': 'status-rejected'
                    };

                    const issueTypes = {
                        'electrical': 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                        'plumbing': 'Ø³Ø¨Ø§ÙƒØ©',
                        'carpentry': 'Ù†Ø¬Ø§Ø±Ø©',
                        'it': 'ØªÙ‚Ù†ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                        'ac': 'ØªÙƒÙŠÙŠÙ',
                        'other': 'Ø£Ø®Ø±Ù‰'
                    };

                    const canRate = request.status === 'completed' && !request.rating;
                    
                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <div class="request-info">
                                    <h3>${issueTypes[request.issueType] || request.issueType} - ${request.location}</h3>
                                    <div class="request-meta">
                                        <span>ğŸ“… ${new Date(request.createdAt).toLocaleDateString('ar-SA')}</span>
                                        ${request.priority === 'high' ? '<span>ğŸ”´ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</span>' : ''}
                                    </div>
                                </div>
                                <span class="request-status ${statusClass[request.status]}">${statusText[request.status]}</span>
                            </div>
                            <p class="request-description">${request.description}</p>
                            ${request.technicianNotes ? `
                                <div style="background: var(--purple-50); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem; border-right: 3px solid var(--purple-500);">
                                    <strong style="color: var(--purple-700); display: block; margin-bottom: 0.5rem;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ:</strong>
                                    <p style="color: var(--gray-700); margin: 0;">${request.technicianNotes}</p>
                                </div>
                            ` : ''}
                            ${canRate ? `
                                <div class="request-actions">
                                    <button onclick="openRatingModal('${request.id}')" class="btn btn-primary btn-small">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</button>
                                </div>
                            ` : ''}
                            ${request.rating ? `
                                <div style="background: var(--success-light); padding: 1rem; border-radius: var(--radius-lg); margin-top: 1rem;">
                                    <strong style="color: var(--success-dark); display: block; margin-bottom: 0.5rem;">ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${'â­'.repeat(request.rating)}</strong>
                                    ${request.ratingComment ? `<p style="color: var(--gray-700); margin: 0;">${request.ratingComment}</p>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        // Open/Close New Request Modal
        function openNewRequestModal() {
            document.getElementById('newRequestModal').classList.add('active');
        }

        function closeNewRequestModal() {
            document.getElementById('newRequestModal').classList.remove('active');
            document.getElementById('newRequestForm').reset();
        }

        // Handle new request submission
        document.getElementById('newRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                clientId: currentUser.id,
                clientName: currentUser.name,
                issueType: document.getElementById('issueType').value,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                priority: document.getElementById('priority').value,
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Handle image upload (in real app, this would be uploaded to server)
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    formData.image = e.target.result;
                    saveRequest(formData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveRequest(formData);
            }
        });

        function saveRequest(formData) {
            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            requests.push(formData);
            localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
            
            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
            closeNewRequestModal();
            loadRequests();
        }

        // Rating functions
        let currentRatingRequestId = null;
        let selectedRating = 0;

        function openRatingModal(requestId) {
            currentRatingRequestId = requestId;
            selectedRating = 0;
            document.getElementById('ratingModal').classList.add('active');
            // Reset stars
            document.querySelectorAll('.rating-star').forEach(star => {
                star.style.opacity = '0.3';
                star.style.cursor = 'pointer';
            });
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            document.getElementById('ratingComment').value = '';
            currentRatingRequestId = null;
            selectedRating = 0;
        }

        function selectRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                star.style.opacity = index < rating ? '1' : '0.3';
            });
        }

        function submitRating() {
            if (selectedRating === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
                return;
            }

            const requests = JSON.parse(localStorage.getItem('maintenanceRequests') || '[]');
            const requestIndex = requests.findIndex(r => r.id === currentRatingRequestId);
            
            if (requestIndex !== -1) {
                requests[requestIndex].rating = selectedRating;
                requests[requestIndex].ratingComment = document.getElementById('ratingComment').value;
                localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
                
                // Update technician rating
                const request = requests[requestIndex];
                if (request.technicianId) {
                    updateTechnicianRating(request.technicianId, selectedRating);
                }
                
                alert('Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!');
                closeRatingModal();
                loadRequests();
            }
        }

        function updateTechnicianRating(technicianId, newRating) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const techIndex = users.findIndex(u => u.id === technicianId);
            
            if (techIndex !== -1) {
                const tech = users[techIndex];
                const currentRating = tech.rating || 0;
                const completedRequests = tech.completedRequests || 0;
                const totalRating = (currentRating * completedRequests) + newRating;
                users[techIndex].rating = totalRating / (completedRequests + 1);
                users[techIndex].completedRequests = completedRequests + 1;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Load requests on page load
        loadRequests();
    </script>
</body>
</html>
