<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0c162c">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙƒÙŠØ© - Ù…Ø´Ø±ÙˆØ¹ Ø·Ù„Ø§Ø¨ÙŠ ØªÙØ§Ø¹Ù„ÙŠ Ù…Ø¹ Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø±Ù…Ø¬ÙŠ Ø°ÙƒÙŠ.">
    <link rel="manifest" href="manifest.webmanifest">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e3c72;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        /* Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ ÙŠØ³Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .school-logo {
            height: 48px;
            width: auto;
            object-fit: contain;
        }

        .nav-btn {
            background: none;
            border: 2px solid #1e3c72;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            color: #1e3c72;
            transition: all 0.3s;
            font-weight: bold;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #1e3c72;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .project-brief {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 15px 45px rgba(30, 60, 114, 0.18);
            display: grid;
            gap: 24px;
        }

        .brief-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #2a5298 0%, #667eea 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: bold;
            font-size: 0.85em;
            box-shadow: 0 10px 25px rgba(42, 82, 152, 0.35);
        }

        .project-brief h1 {
            font-size: 2.2em;
            color: #1e3c72;
            margin-top: 10px;
        }

        .project-brief p {
            color: #445b7a;
            line-height: 1.8;
            font-size: 1.05em;
        }

        .brief-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .brief-meta {
            display: grid;
            gap: 16px;
        }

        .brief-summary {
            display: grid;
            gap: 16px;
        }

        .meta-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #dde7ff 100%);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 10px 28px rgba(27, 53, 104, 0.18);
            display: grid;
            gap: 8px;
        }

        .meta-card span {
            display: block;
        }

        .meta-label {
            color: #5b6d88;
            font-size: 0.85em;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .meta-value {
            color: #1e3c72;
            font-size: 1.15em;
            font-weight: 800;
        }

        .brief-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 10px;
        }

        .brief-list li {
            position: relative;
            padding-inline-start: 26px;
            color: #365075;
            font-weight: 600;
        }

        .brief-list li::before {
            content: 'â–¹';
            position: absolute;
            inset-inline-start: 0;
            color: #1e3c72;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: white;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(30, 60, 114, 0.08);
            box-shadow: 0 12px 30px rgba(30, 60, 114, 0.12);
        }

        .summary-card .summary-label {
            color: #5b6d88;
            font-size: 0.85em;
        }

        .summary-card .summary-value {
            display: block;
            margin-top: 6px;
            font-size: 1.6em;
            font-weight: 800;
            color: #1e3c72;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-info h3 {
            font-size: 2em;
            color: #333;
        }

        .stat-info p {
            color: #666;
            margin-top: 5px;
        }

        .main-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .main-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 30px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 30px;
            font-size: 1em;
            cursor: pointer;
            background: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .book-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .book-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .book-cover {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            margin-bottom: 15px;
        }

        .book-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .book-info {
            color: #666;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .book-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }

        .available {
            background: #d4edda;
            color: #155724;
        }

        .borrowed {
            background: #fff3cd;
            color: #856404;
        }

        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-borrow {
            background: #28a745;
            color: white;
        }

        .btn-borrow:hover {
            background: #218838;
        }

        .btn-return {
            background: #ffc107;
            color: #333;
        }

        .btn-return:hover {
            background: #e0a800;
        }

        .borrowed-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .borrowed-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            border-right: 5px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .borrowed-info h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .borrowed-info p {
            color: #666;
            font-size: 0.9em;
        }

        .due-date {
            background: #fff3cd;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: #856404;
        }

        .overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .notification-badge {
            position: relative;
        }

        .badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
        }

        .notifications-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }

        .notification-item.warning {
            border-right-color: #ffc107;
            background: #fff9e6;
        }

        .notification-item.urgent {
            border-right-color: #dc3545;
            background: #ffe6e6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .history-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 360px;
            overflow-y: auto;
            padding-inline-end: 6px;
        }

        .history-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 14px;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fc 0%, #eef2ff 100%);
            border-radius: 16px;
            padding: 16px;
            border-right: 5px solid #667eea;
            box-shadow: 0 6px 18px rgba(45, 55, 72, 0.12);
        }

        .history-item.return {
            border-right-color: #38b2ac;
        }

        .history-item.add {
            border-right-color: #f6ad55;
        }

        .history-icon {
            font-size: 1.8em;
        }

        .history-title {
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 6px;
        }

        .history-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85em;
            color: #5b6d88;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            border: 2px dashed rgba(102, 126, 234, 0.35);
            border-radius: 16px;
            color: #5b6d88;
            font-weight: 600;
        }

        .btn-small:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            inset-inline-end: 30px;
            background: rgba(30, 60, 114, 0.95);
            color: white;
            padding: 14px 22px;
            border-radius: 14px;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1100;
            pointer-events: none;
            font-weight: 600;
        }

        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">ğŸ“š Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
        <div class="nav-links">
            <button class="nav-btn active" data-section="browse" onclick="showSection(event, 'browse')">ØªØµÙØ­ Ø§Ù„ÙƒØªØ¨</button>
            <button class="nav-btn" data-section="borrowed" onclick="showSection(event, 'borrowed')">
                <span class="notification-badge">
                    Ø§Ø³ØªØ¹Ø§Ø±Ø§ØªÙŠ
                    <span class="badge" id="borrowedCount">0</span>
                </span>
            </button>
            <button class="nav-btn" data-section="history" onclick="showSection(event, 'history')">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
            <button class="nav-btn" data-section="notifications" onclick="showSection(event, 'notifications')">
                <span class="notification-badge">
                    Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    <span class="badge" id="notifCount">0</span>
                </span>
            </button>
            <button class="btn-primary" onclick="openAddBookModal()">â• Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</button>
        </div>
        <!-- Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ -->
        <img src="assets/logo.svg" alt="Ø´Ø¹Ø§Ø± Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø´ÙƒØ§Ø©" class="school-logo" />
    </div>

    <section class="project-brief">
        <span class="brief-pill">Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ÙŠØ©</span>
        <h1>Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù„Ù„Ù…ÙƒØªØ¨Ø© - Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø´ÙƒØ§Ø©</h1>
        <p>Ù…Ù†ØµØ© ÙˆØ§Ø­Ø¯Ø© ØªØ¬Ù…Ø¹ Ø§Ù„Ø¬Ø±Ø¯ØŒ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©ØŒ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© ÙÙŠ ØªØ¬Ø±Ø¨Ø© Ù…ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆØªØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³Ø±Ø¹Ø© Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±.</p>
        <div class="brief-grid">
            <div class="brief-meta">
                <div class="meta-card">
                    <span class="meta-label">Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©</span>
                    <span class="meta-value">Ù…ÙƒØªØ¨Ø© Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø´ÙƒØ§Ø©</span>
                </div>
                <div class="meta-card">
                    <span class="meta-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span>
                    <span class="meta-value">ØªØ´ØºÙŠÙ„ ÙØ¹Ù„ÙŠ Ù…Ù†Ø° Ø³Ø¨ØªÙ…Ø¨Ø± 2025</span>
                </div>
                <div class="meta-card">
                    <span class="meta-label">Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„</span>
                    <span class="meta-value">Ù†Ø¸Ø§Ù… Ù†ÙˆØ± â€¢ Azure AD â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</span>
                </div>
                <ul class="brief-list">
                    <li>Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª ÙÙˆØ±ÙŠØ© ØªÙˆØ¶Ø­ Ø§Ù„ØªØ²Ø§Ù… ÙƒÙ„ ØµÙ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø©.</li>
                    <li>Ù…Ø­Ø±Ùƒ ØªÙˆØµÙŠØ© ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø®Ù„Ø§Ù„ 18 Ø´Ù‡Ø±Ø§Ù‹.</li>
                    <li>Ø³ÙŠØ§Ø³Ø© Ø£Ø°ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.</li>
                </ul>
            </div>
            <div class="brief-summary">
                <div class="summary-grid">
                    <div class="summary-card">
                        <span class="summary-label">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙˆØ³Ø·ÙŠ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</span>
                        <span class="summary-value" id="summaryKpiSpeed">12 Ø«Ø§Ù†ÙŠØ©</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø´Ù‡Ø±ÙŠØ§Ù‹</span>
                        <span class="summary-value" id="summaryKpiUsers">420</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…</span>
                        <span class="summary-value" id="summaryKpiSatisfaction">4.7/5</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">ØªØºØ·ÙŠØ© Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„Ù…</span>
                        <span class="summary-value">95Ùª Ù…Ù† Ù…Ù†Ø§Ù‡Ø¬ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“–</div>
                <div class="stat-info">
                    <h3 id="totalBooks">247</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-info">
                    <h3 id="availableBooks">189</h3>
                    <p>ÙƒØªØ¨ Ù…ØªØ§Ø­Ø©</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“š</div>
                <div class="stat-info">
                    <h3 id="borrowedBooks">58</h3>
                    <p>ÙƒØªØ¨ Ù…Ø³ØªØ¹Ø§Ø±Ø©</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <h3>412</h3>
                    <p>Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·</p>
                </div>
            </div>
        </div>

        <div class="main-section active" id="browseSection">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ØŒ Ù…Ø¤Ù„ÙØŒ Ø£Ùˆ Ø±Ù‚Ù… ISBN...">
                <select class="filter-select" id="categoryFilter">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
                    <option value="science">Ø¹Ù„ÙˆÙ…</option>
                    <option value="literature">Ø£Ø¯Ø¨</option>
                    <option value="history">ØªØ§Ø±ÙŠØ®</option>
                    <option value="tech">ØªÙ‚Ù†ÙŠØ©</option>
                    <option value="religion">Ø¯ÙŠÙ†</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="available">Ù…ØªØ§Ø­</option>
                    <option value="borrowed">Ù…Ø³ØªØ¹Ø§Ø±</option>
                </select>
            </div>
            <div class="books-grid" id="booksGrid"></div>
        </div>

        <div class="main-section" id="borrowedSection">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ“š ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©</h2>
            <div class="borrowed-list" id="borrowedList"></div>
        </div>

        <div class="main-section" id="notificationsSection">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
            <div class="notifications-panel" id="notificationsList"></div>
        </div>

        <div class="main-section" id="historySection">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ—‚ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
            <div class="history-summary">
                <div class="summary-card">
                    <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</span>
                    <span class="summary-value" id="summaryTotal">0</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">ÙƒØªØ¨ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ø¢Ù†</span>
                    <span class="summary-value" id="summaryBorrowed">0</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">ÙƒØªØ¨ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</span>
                    <span class="summary-value" id="summaryAvailable">0</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Ø­Ø±ÙƒØ§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</span>
                    <span class="summary-value" id="summaryRecent">0</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Ø£ÙƒØ«Ø± ÙØ¦Ø© Ø·Ù„Ø¨Ø§Ù‹</span>
                    <span class="summary-value" id="summaryTopCategory">â€”</span>
                </div>
            </div>
            <div class="history-timeline" id="historyTimeline"></div>
        </div>
    </div>

    <div class="modal" id="addBookModal">
        <div class="modal-content">
            <h2>â• Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="form-group">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨</label>
                <input type="text" id="bookTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
            </div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù</label>
                <input type="text" id="bookAuthor" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù">
            </div>
            <div class="form-group">
                <label>Ø§Ù„ÙØ¦Ø©</label>
                <select id="bookCategory">
                    <option value="science">Ø¹Ù„ÙˆÙ…</option>
                    <option value="literature">Ø£Ø¯Ø¨</option>
                    <option value="history">ØªØ§Ø±ÙŠØ®</option>
                    <option value="tech">ØªÙ‚Ù†ÙŠØ©</option>
                    <option value="religion">Ø¯ÙŠÙ†</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø±Ù‚Ù… ISBN</label>
                <input type="text" id="bookISBN" placeholder="978-XXXX-XXXX">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeAddBookModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn-primary" onclick="addNewBook()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        const CATEGORY_LABELS = {
            science: 'Ø¹Ù„ÙˆÙ…',
            literature: 'Ø£Ø¯Ø¨',
            history: 'ØªØ§Ø±ÙŠØ®',
            tech: 'ØªÙ‚Ù†ÙŠØ©',
            religion: 'Ø¯ÙŠÙ†'
        };

        const CATEGORY_ICONS = {
            science: 'ğŸ”¬',
            literature: 'ğŸ“š',
            history: 'ğŸ“œ',
            tech: 'ğŸ’»',
            religion: 'ğŸ“¿'
        };

        const STORAGE_KEYS = {
            books: 'mishkat-library-books',
            borrowed: 'mishkat-library-borrowed',
            history: 'mishkat-library-history'
        };

        const HISTORY_META = {
            borrow: { icon: 'ğŸ“˜', text: 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø±Ø©' },
            return: { icon: 'ğŸ“—', text: 'ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹' },
            add: { icon: 'ğŸ†•', text: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ©' }
        };

        const clone = (value) => JSON.parse(JSON.stringify(value));

        const defaultBooks = [
            { id: 1, title: 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹', author: 'Ø¯. Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯', category: 'tech', isbn: '978-1234-5678', icon: 'ğŸ¤–', status: 'available' },
            { id: 2, title: 'Ø±Ø­Ù„Ø© ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', author: 'Ø¯. Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ', category: 'science', isbn: '978-2345-6789', icon: 'âš›ï¸', status: 'available' },
            { id: 3, title: 'Ù‚ØµØµ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ', author: 'Ø£Ø­Ù…Ø¯ Ø­Ø³Ù†', category: 'history', isbn: '978-3456-7890', icon: 'ğŸ“œ', status: 'borrowed', dueDate: '2025-11-05' },
            { id: 4, title: 'Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø¨Ù„ØºØ© Python', author: 'Ø¹Ù…Ø± Ø®Ø§Ù„Ø¯', category: 'tech', isbn: '978-4567-8901', icon: 'ğŸ', status: 'available' },
            { id: 5, title: 'Ø±ÙˆØ§Ø¦Ø¹ Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ', author: 'ÙØ§Ø·Ù…Ø© Ù…Ø­Ù…ÙˆØ¯', category: 'literature', isbn: '978-5678-9012', icon: 'ğŸ“', status: 'available' },
            { id: 6, title: 'Ø¹Ù„ÙˆÙ… Ø§Ù„ÙØ¶Ø§Ø¡ ÙˆØ§Ù„ÙƒÙˆÙ†', author: 'Ø¯. ÙŠÙˆØ³Ù Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', category: 'science', isbn: '978-6789-0123', icon: 'ğŸš€', status: 'borrowed', dueDate: '2025-11-08' },
            { id: 7, title: 'ÙÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ', author: 'Ù„ÙŠÙ„Ù‰ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', category: 'tech', isbn: '978-7890-1234', icon: 'ğŸ¨', status: 'available' },
            { id: 8, title: 'Ø§Ù„ÙÙ‚Ù‡ Ø§Ù„Ù…ÙŠØ³Ø±', author: 'Ø¯. Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®', category: 'religion', isbn: '978-8901-2345', icon: 'ğŸ“¿', status: 'available' },
            { id: 9, title: 'Ø§Ù„Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³', author: 'Ù…. Ø§Ø¨ØªØ³Ø§Ù… Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ', category: 'science', isbn: '978-9012-3456', icon: 'ğŸŒ±', status: 'available' },
            { id: 10, title: 'Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ÙÙŠØ²ÙŠØ§Ø¡', author: 'Ø¯. Ø¹Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø¯ÙŠ', category: 'science', isbn: '978-0123-4567', icon: 'ğŸ§ª', status: 'available' },
            { id: 11, title: 'Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø§Ù„ØªØ±Ø¨ÙˆÙŠ', author: 'Ø£. Ù…Ø±ÙŠÙ… Ø§Ù„Ø³Ø¨ÙŠØ¹ÙŠ', category: 'literature', isbn: '978-3210-6543', icon: 'ğŸ’¡', status: 'available' },
            { id: 12, title: 'Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨', author: 'Ø¯. Ù‡Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¨Ø¯Ø§Ù„ÙƒØ±ÙŠÙ…', category: 'tech', isbn: '978-2109-8765', icon: 'ğŸ“˜', status: 'available' }
        ];

        const baseNotifications = [
            { id: 'integration', message: 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø±Ø¨Ø· Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©.', type: 'info', date: '2025-10-27' },
            { id: 'policy', message: 'ØªØ°ÙƒÙŠØ±: Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© ØªÙØ¹Ù„Ù‘Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯ 48 Ø³Ø§Ø¹Ø©.', type: 'warning', date: '2025-10-26' }
        ];

        function loadFromStorage(key, fallback) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return clone(fallback);
                const parsed = JSON.parse(raw);
                if (key === STORAGE_KEYS.books && !Array.isArray(parsed)) return clone(fallback);
                if ((key === STORAGE_KEYS.borrowed || key === STORAGE_KEYS.history) && !Array.isArray(parsed)) return [];
                return parsed;
            } catch {
                return clone(fallback);
            }
        }

        function saveBooks() { localStorage.setItem(STORAGE_KEYS.books, JSON.stringify(books)); }
        function saveBorrowed() { localStorage.setItem(STORAGE_KEYS.borrowed, JSON.stringify(myBorrowedBooks)); }
        function saveHistory() { localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(loanHistory)); }

        let books = loadFromStorage(STORAGE_KEYS.books, defaultBooks);
        let myBorrowedBooks = loadFromStorage(STORAGE_KEYS.borrowed, []);
        let loanHistory = loadFromStorage(STORAGE_KEYS.history, []);

        const toast = document.getElementById('toast');
        const summaryRefs = {
            total: document.getElementById('summaryTotal'),
            borrowed: document.getElementById('summaryBorrowed'),
            available: document.getElementById('summaryAvailable'),
            recent: document.getElementById('summaryRecent'),
            topCategory: document.getElementById('summaryTopCategory'),
            kpiSpeed: document.getElementById('summaryKpiSpeed'),
            kpiUsers: document.getElementById('summaryKpiUsers'),
            kpiSatisfaction: document.getElementById('summaryKpiSatisfaction')
        };
        const notifCountEl = document.getElementById('notifCount');
        const borrowedBadge = document.getElementById('borrowedCount');

        const booksGrid = document.getElementById('booksGrid');
        const borrowedList = document.getElementById('borrowedList');
        const notificationsList = document.getElementById('notificationsList');
        const historyTimeline = document.getElementById('historyTimeline');

        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');

        const sections = {
            browse: document.getElementById('browseSection'),
            borrowed: document.getElementById('borrowedSection'),
            notifications: document.getElementById('notificationsSection'),
            history: document.getElementById('historySection')
        };
        const navButtons = Array.from(document.querySelectorAll('.nav-btn'));

        const state = { toastTimeout: null };

        sanitizeData();

        function sanitizeData() {
            if (!Array.isArray(books) || !books.length) {
                books = clone(defaultBooks);
            }
            books = books.map((book, index) => {
                const category = CATEGORY_LABELS[book.category] ? book.category : 'literature';
                const status = book.status === 'borrowed' ? 'borrowed' : 'available';
                return {
                    id: typeof book.id === 'number' ? book.id : index + 1,
                    title: book.title || 'ÙƒØªØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                    author: book.author || 'Ù…Ø¤Ù„Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    category,
                    isbn: book.isbn || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                    icon: book.icon || CATEGORY_ICONS[category] || 'ğŸ“˜',
                    status,
                    dueDate: book.dueDate || null,
                    borrower: book.borrower || (status === 'borrowed' ? 'Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©' : null)
                };
            });
            const validIds = new Set(books.map(book => book.id));
            if (!Array.isArray(myBorrowedBooks)) myBorrowedBooks = [];
            myBorrowedBooks = myBorrowedBooks.filter(entry => entry && validIds.has(entry.id));
            myBorrowedBooks.forEach(entry => {
                const book = books.find(b => b.id === entry.id);
                if (!book) return;
                book.status = 'borrowed';
                book.dueDate = entry.dueDate || book.dueDate || null;
                book.borrower = entry.borrower || 'Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©';
            });
            if (!Array.isArray(loanHistory)) loanHistory = [];
            loanHistory = loanHistory.filter(item => item && item.id);
            saveBooks();
            saveBorrowed();
            saveHistory();
        }

        function showToast(message) {
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('visible');
            clearTimeout(state.toastTimeout);
            state.toastTimeout = setTimeout(() => toast.classList.remove('visible'), 3400);
        }

        function setActiveButton(section) {
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.section === section));
        }

        function showSection(evt, section) {
            Object.values(sections).forEach(el => el.classList.remove('active'));
            const targetSection = sections[section] || sections.browse;
            targetSection.classList.add('active');

            if (evt && evt.currentTarget) {
                navButtons.forEach(btn => btn.classList.remove('active'));
                evt.currentTarget.classList.add('active');
            } else {
                setActiveButton(section);
            }

            if (section === 'borrowed') {
                displayBorrowedBooks();
            } else if (section === 'notifications') {
                displayNotifications();
            } else if (section === 'history') {
                displayHistory();
            }
        }

        function displayBooks() {
            const searchValue = (searchInput.value || '').toLowerCase();
            const categoryValue = categoryFilter.value;
            const statusValue = statusFilter.value;

            const filtered = books.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(searchValue) ||
                    book.author.toLowerCase().includes(searchValue) ||
                    book.isbn.toLowerCase().includes(searchValue);
                const matchesCategory = categoryValue === 'all' || book.category === categoryValue;
                const matchesStatus = statusValue === 'all' || book.status === statusValue;
                return matchesSearch && matchesCategory && matchesStatus;
            });

            if (!filtered.length) {
                booksGrid.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>';
            } else {
                booksGrid.innerHTML = filtered.map(book => {
                    const borrowedRecord = myBorrowedBooks.find(entry => entry.id === book.id);
                    const dueDate = borrowedRecord?.dueDate || book.dueDate;
                    const dueInfo = dueDate ? `<div class="book-info">â° Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: ${formatDate(dueDate)}</div>` : '';
                    const borrowerInfo = book.status === 'borrowed' && !borrowedRecord
                        ? '<div class="book-info">ğŸ‘¤ Ù…Ø³ØªØ¹Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ø²Ù…ÙŠÙ„ Ø¢Ø®Ø±</div>'
                        : '';
                    const statusLabel = book.status === 'available' ? 'Ù…ØªØ§Ø­' : 'Ù…Ø³ØªØ¹Ø§Ø±';
                    const actionButton = book.status === 'available'
                        ? `<button class="btn-small btn-borrow" onclick="borrowBook(${book.id})">Ø§Ø³ØªØ¹Ø§Ø±Ø©</button>`
                        : borrowedRecord
                            ? `<button class="btn-small btn-return" onclick="returnBook(${book.id})">Ø¥Ø±Ø¬Ø§Ø¹</button>`
                            : `<button class="btn-small btn-return" disabled>Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</button>`;
                    return `
                        <div class="book-card">
                            <div class="book-cover">${book.icon || CATEGORY_ICONS[book.category] || 'ğŸ“—'}</div>
                            <div class="book-title">${book.title}</div>
                            <div class="book-info">ğŸ“ Ø§Ù„Ù…Ø¤Ù„Ù: ${book.author}</div>
                            <div class="book-info">ğŸ”¢ ISBN: ${book.isbn}</div>
                            <span class="book-status ${book.status}">${statusLabel}</span>
                            ${dueInfo}
                            ${borrowerInfo}
                            <div class="book-actions">
                                ${actionButton}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateStats();
        }

        function borrowBook(id) {
            const book = books.find(b => b.id === id);
            if (!book || book.status === 'borrowed') {
                showToast('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.');
                return;
            }
            const existing = myBorrowedBooks.find(entry => entry.id === id);
            if (existing) {
                showToast('Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø³ØªØ¹Ø§Ø±Ø§ØªÙƒ.');
                return;
            }
            const due = new Date();
            due.setDate(due.getDate() + 14);
            const dueDate = due.toISOString().split('T')[0];
            const record = {
                id: book.id,
                borrowedAt: new Date().toISOString(),
                dueDate,
                borrower: 'Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©'
            };
            book.status = 'borrowed';
            book.dueDate = dueDate;
            book.borrower = 'Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©';
            myBorrowedBooks.push(record);
            addHistory('borrow', book, { dueDate, category: book.category });
            saveBooks();
            saveBorrowed();
            displayBooks();
            displayBorrowedBooks();
            renderHistorySummary();
            showToast(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø±Ø© "${book.title}" Ø¨Ù†Ø¬Ø§Ø­. Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: ${formatDate(dueDate)}`);
        }

        function returnBook(id) {
            const book = books.find(b => b.id === id);
            if (!book || book.status !== 'borrowed') {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø¢Ù†.');
                return;
            }
            book.status = 'available';
            book.dueDate = null;
            book.borrower = null;
            myBorrowedBooks = myBorrowedBooks.filter(entry => entry.id !== id);
            addHistory('return', book, { category: book.category });
            saveBooks();
            saveBorrowed();
            displayBooks();
            displayBorrowedBooks();
            renderHistorySummary();
            showToast(`ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ "${book.title}" Ø¨Ù†Ø¬Ø§Ø­.`);
        }

        function displayBorrowedBooks() {
            if (!borrowedList) return;
            if (!myBorrowedBooks.length) {
                borrowedList.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø³ØªØ¹Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
                return;
            }
            const sorted = [...myBorrowedBooks].sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            borrowedList.innerHTML = sorted.map(entry => {
                const book = books.find(b => b.id === entry.id);
                if (!book) return '';
                const dueDate = entry.dueDate ? formatDate(entry.dueDate) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const isOverdue = entry.dueDate && new Date(entry.dueDate) < new Date();
                return `
                    <div class="borrowed-item">
                        <div class="borrowed-info">
                            <h3>${book.icon || 'ğŸ“˜'} ${book.title}</h3>
                            <p>Ø§Ù„Ù…Ø¤Ù„Ù: ${book.author}</p>
                            <p>ISBN: ${book.isbn}</p>
                        </div>
                        <div>
                            <div class="due-date ${isOverdue ? 'overdue' : ''}">
                                ${isOverdue ? 'âš ï¸ Ù…ØªØ£Ø®Ø±' : 'ğŸ“…'} Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: ${dueDate}
                            </div>
                            <button class="btn-small btn-return" style="margin-top: 10px; width: 100%;" onclick="returnBook(${book.id})">Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¢Ù†</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateDynamicNotifications() {
            const now = new Date();
            const notifications = [];
            myBorrowedBooks.forEach(entry => {
                if (!entry.dueDate) return;
                const due = new Date(entry.dueDate);
                const book = books.find(b => b.id === entry.id);
                if (!book) return;
                const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                if (diffDays < 0) {
                    notifications.push({
                        id: `overdue-${entry.id}`,
                        message: `ØªØ£Ø®Ø± Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØªØ§Ø¨ "${book.title}" Ù„Ù…Ø¯Ø© ${Math.abs(diffDays)} ÙŠÙˆÙ…`,
                        type: 'urgent',
                        date: formatDate(now)
                    });
                } else if (diffDays <= 3) {
                    notifications.push({
                        id: `due-${entry.id}`,
                        message: `Ø§Ù‚ØªØ±Ø¨ Ù…ÙˆØ¹Ø¯ Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØªØ§Ø¨ "${book.title}" Ø®Ù„Ø§Ù„ ${diffDays} ÙŠÙˆÙ…`,
                        type: 'warning',
                        date: formatDate(now)
                    });
                }
            });
            if (loanHistory.length) {
                const latest = loanHistory[loanHistory.length - 1];
                const meta = HISTORY_META[latest.action] || { text: 'Ø­Ø±ÙƒØ©', icon: 'ğŸ“˜' };
                notifications.unshift({
                    id: `latest-${latest.id}`,
                    message: `${meta.text} "${latest.title}"`,
                    type: 'info',
                    date: formatDateTime(latest.timestamp)
                });
            }
            return notifications;
        }

        function displayNotifications() {
            if (!notificationsList) return;
            const dynamic = generateDynamicNotifications();
            const combined = [...dynamic, ...baseNotifications];
            if (!combined.length) {
                notificationsList.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.</div>';
            } else {
                notificationsList.innerHTML = combined.map(notif => `
                    <div class="notification-item ${notif.type}">
                        <strong>${notif.message}</strong>
                        <p style="color: #999; margin-top: 5px; font-size: 0.9em;">${notif.date}</p>
                    </div>
                `).join('');
            }
            if (notifCountEl) {
                notifCountEl.textContent = combined.length;
            }
        }

        function addHistory(action, book, details = {}) {
            const entry = {
                id: `${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
                action,
                bookId: book.id,
                title: book.title,
                timestamp: new Date().toISOString(),
                details
            };
            loanHistory.push(entry);
            loanHistory = loanHistory.slice(-50);
            saveHistory();
        }

        function displayHistory() {
            renderHistorySummary();
            if (!historyTimeline) return;
            if (!loanHistory.length) {
                historyTimeline.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</div>';
                return;
            }
            historyTimeline.innerHTML = loanHistory.slice().reverse().map(entry => {
                const meta = HISTORY_META[entry.action] || { icon: 'ğŸ“˜', text: 'Ø­Ø±ÙƒØ©' };
                const book = books.find(b => b.id === entry.bookId) || { title: entry.title };
                const dueInfo = entry.details && entry.details.dueDate
                    ? `<span>â° Ù…Ø³ØªØ­Ù‚: ${formatDate(entry.details.dueDate)}</span>`
                    : '';
                const categoryName = entry.details && entry.details.category
                    ? CATEGORY_LABELS[entry.details.category] || entry.details.category
                    : '';
                const categoryInfo = categoryName ? `<span>ğŸ·ï¸ ${categoryName}</span>` : '';
                return `
                    <div class="history-item ${entry.action}">
                        <div class="history-icon">${meta.icon}</div>
                        <div>
                            <div class="history-title">${meta.text} <strong>${book.title}</strong></div>
                            <div class="history-meta">
                                <span>ğŸ•’ ${formatDateTime(entry.timestamp)}</span>
                                ${dueInfo}
                                ${categoryInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getAnalyticsSnapshot() {
            const totalBooks = books.length;
            const borrowedNow = books.filter(book => book.status === 'borrowed').length;
            const availableNow = totalBooks - borrowedNow;
            const now = new Date();
            const sevenDaysAgo = new Date(now);
            sevenDaysAgo.setDate(now.getDate() - 7);
            const recentMovements = loanHistory.filter(entry => new Date(entry.timestamp) >= sevenDaysAgo).length;
            const borrowActions = loanHistory.filter(entry => entry.action === 'borrow');
            const categoryCounts = borrowActions.reduce((acc, entry) => {
                const category = entry.details?.category || books.find(book => book.id === entry.bookId)?.category;
                if (!category) return acc;
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            const topCategoryEntry = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0];
            return {
                totalBooks,
                borrowedNow,
                availableNow,
                recentMovements,
                topCategory: topCategoryEntry ? CATEGORY_LABELS[topCategoryEntry[0]] || topCategoryEntry[0] : 'â€”',
                topCategoryCount: topCategoryEntry ? topCategoryEntry[1] : 0
            };
        }

        function renderHistorySummary() {
            if (!summaryRefs.total) return;
            const snapshot = getAnalyticsSnapshot();
            summaryRefs.total.textContent = snapshot.totalBooks;
            summaryRefs.borrowed.textContent = snapshot.borrowedNow;
            summaryRefs.available.textContent = snapshot.availableNow;
            summaryRefs.recent.textContent = snapshot.recentMovements;
            summaryRefs.topCategory.textContent = snapshot.topCategory === 'â€”'
                ? 'â€”'
                : `${snapshot.topCategory} (${snapshot.topCategoryCount})`;
        }

        function updateStats() {
            const available = books.filter(b => b.status === 'available').length;
            const borrowed = books.filter(b => b.status === 'borrowed').length;
            document.getElementById('totalBooks').textContent = books.length;
            document.getElementById('availableBooks').textContent = available;
            document.getElementById('borrowedBooks').textContent = borrowed;
            if (borrowedBadge) borrowedBadge.textContent = myBorrowedBooks.length;
            renderHistorySummary();
        }

        function formatDate(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.valueOf())) return value;
            return date.toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateTime(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.valueOf())) return value;
            return date.toLocaleString('ar-SA', { dateStyle: 'medium', timeStyle: 'short' });
        }

        function openAddBookModal() {
            document.getElementById('addBookModal').classList.add('active');
        }

        function closeAddBookModal() {
            document.getElementById('addBookModal').classList.remove('active');
        }

        function getNextId() {
            return books.reduce((max, book) => Math.max(max, book.id || 0), 0) + 1;
        }

        function addNewBook() {
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const category = document.getElementById('bookCategory').value;
            const isbn = document.getElementById('bookISBN').value.trim();

            if (!title || !author || !isbn) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù ÙˆØ±Ù‚Ù… ISBN.');
                return;
            }

            const newBook = {
                id: getNextId(),
                title,
                author,
                category: CATEGORY_LABELS[category] ? category : 'literature',
                isbn,
                icon: CATEGORY_ICONS[category] || 'ğŸ“–',
                status: 'available',
                dueDate: null,
                borrower: null
            };

            books.push(newBook);
            saveBooks();
            addHistory('add', newBook, { category: newBook.category });
            displayBooks();
            showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${newBook.title}" Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø©.`);
            closeAddBookModal();
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookISBN').value = '';
        }

        searchInput.addEventListener('input', displayBooks);
        categoryFilter.addEventListener('change', displayBooks);
        statusFilter.addEventListener('change', displayBooks);

        displayBooks();
        displayBorrowedBooks();
        displayNotifications();
        displayHistory();
    </script>
    <script>
        (function(){
            function post(type, e){
                try {
                    if (window.parent) {
                        window.parent.postMessage({ __fromProjectFrame: true, type, x: e && e.clientX, y: e && e.clientY }, '*');
                    }
                } catch {}
            }
            window.addEventListener('mousemove', (e) => post('cursor-move', e), { passive: true });
            window.addEventListener('mouseenter', (e) => post('cursor-enter', e), { passive: true });
            window.addEventListener('mouseleave', () => post('cursor-leave'), { passive: true });
            window.addEventListener('mousedown', (e) => post('cursor-down', e), { passive: true });
            window.addEventListener('mouseup', (e) => post('cursor-up', e), { passive: true });
        })();
    </script>
    <script src="assets/app.js" defer></script>
    <script src="assets/ai-assistant.js" defer></script>
</body>
</html>